# NOTE: In production, use one of the following for secret management:
# - Sealed Secrets (Bitnami)
# - External Secrets Operator
# - HashiCorp Vault
# - AWS Secrets Manager / GCP Secret Manager
#
# This template shows the structure. Never commit real secrets!

{{- if .Values.secrets.create }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "skylink.fullname" . }}-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "skylink.labels" . | nindent 4 }}
type: Opaque
stringData:
  # JWT Keys - MUST be provided via values or --set
  JWT_PRIVATE_KEY: {{ .Values.secrets.jwtPrivateKey | quote }}
  JWT_PUBLIC_KEY: {{ .Values.secrets.jwtPublicKey | quote }}

  # AES-256 Encryption Key (64 hex characters)
  ENCRYPTION_KEY: {{ .Values.secrets.encryptionKey | quote }}

  {{- if .Values.postgresql.enabled }}
  # PostgreSQL connection string
  DATABASE_URL: "postgresql://{{ .Values.postgresql.auth.username }}:{{ .Values.postgresql.auth.password }}@{{ include "skylink.fullname" . }}-postgresql:5432/{{ .Values.postgresql.auth.database }}"
  {{- end }}
{{- else }}
---
# Placeholder secret - to be populated by External Secrets Operator or similar
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "skylink.fullname" . }}-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "skylink.labels" . | nindent 4 }}
  {{- if .Values.secrets.externalSecrets.enabled }}
  annotations:
    # For External Secrets Operator
    externalsecrets.kubernetes.io/managed: "true"
  {{- end }}
type: Opaque
# Data will be populated by external secret manager
data: {}
{{- end }}

{{- if .Values.secrets.externalSecrets.enabled }}
---
# External Secret definition (requires External Secrets Operator)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "skylink.fullname" . }}-external-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "skylink.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStoreRef.kind }}
  target:
    name: {{ include "skylink.fullname" . }}-secrets
    creationPolicy: Owner
  data:
    - secretKey: JWT_PRIVATE_KEY
      remoteRef:
        key: skylink/jwt-private-key
    - secretKey: JWT_PUBLIC_KEY
      remoteRef:
        key: skylink/jwt-public-key
    - secretKey: ENCRYPTION_KEY
      remoteRef:
        key: skylink/encryption-key
    {{- if .Values.postgresql.enabled }}
    - secretKey: DATABASE_URL
      remoteRef:
        key: skylink/database-url
    {{- end }}
{{- end }}
